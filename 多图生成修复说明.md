# 🔧 多图生成功能修复说明

## ✅ 已修复的问题

### 1. 图片尺寸错误
**问题**: API 要求图片尺寸至少 3,686,400 像素（约 1920x1920），但之前设置的是 768x1024 = 786,432 像素

**修复**:
- ✅ 自动计算并调整图片尺寸，确保至少 1920x1920
- ✅ 如果提供的尺寸不够，按比例自动放大
- ✅ 确保尺寸是 8 的倍数（某些模型要求）

**代码位置**: `src/lib/ai.ts` (第 102-117 行)

### 2. 多图生成功能
**需求**: 将用户照片 + 选择的多个衣物图片合成一张图片

**实现**:
- ✅ 支持传递多个图片（用户照片 + 衣物图片数组）
- ✅ 自动构建包含衣物信息的 prompt
- ✅ 支持 base64 和 HTTP URL 两种格式
- ✅ 智能处理图片引用（最多 3 个 URL 图片）

**代码位置**: 
- `src/app/virtual-tryon/page.tsx` (第 82-127 行)
- `src/lib/ai.ts` (第 37-75 行)

### 3. 错误处理优化
**改进**:
- ✅ 识别并友好提示尺寸错误
- ✅ 识别并友好提示长度错误
- ✅ 解析嵌套的 JSON 错误消息

**代码位置**: `src/lib/ai.ts` (第 154-194 行)

---

## 🎯 功能说明

### 多图生成流程

1. **用户上传照片** → 作为主要参考图片
2. **选择衣物** → 最多选择 3 件衣物
3. **构建 Prompt** → 自动添加衣物描述
4. **生成图片** → 将用户照片和衣物合成一张图片

### 图片尺寸处理

- **最小尺寸**: 1920x1920 (3,686,400 像素)
- **自动调整**: 如果提供的尺寸不够，会自动按比例放大
- **8 的倍数**: 确保尺寸是 8 的倍数（模型要求）

### Prompt 构建

示例：
```
原始 prompt: "时尚写真，工作室灯光，高级质感，人物正面"
选择的衣物: ["白色基础 T 恤", "黑色休闲裤"]
最终 prompt: "时尚写真，工作室灯光，高级质感，人物正面，穿着：白色基础 T 恤、黑色休闲裤 --reference_image [用户照片URL] --style_reference_1 [衣物1URL] --style_reference_2 [衣物2URL]"
```

---

## 📝 使用说明

### 前端调用

```typescript
const res = await fetch("/api/ai/generate-image", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ 
    prompt: "时尚写真，工作室灯光",
    image: [
      userPhoto,        // 用户照片（base64 或 URL）
      item1.image,    // 衣物1图片
      item2.image,    // 衣物2图片
    ],
    width: 1920,      // 自动调整为至少 1920
    height: 1920,     // 自动调整为至少 1920
    num_inference_steps: 28, 
    guidance_scale: 3.5 
  })
})
```

### API 参数

| 参数 | 类型 | 说明 |
|------|------|------|
| `prompt` | string | 生成描述（最大 10000 字符） |
| `image` | string \| string[] | 单个图片或图片数组 |
| `width` | number | 图片宽度（自动调整最小 1920） |
| `height` | number | 图片高度（自动调整最小 1920） |
| `num_inference_steps` | number | 推理步数（可选） |
| `guidance_scale` | number | 引导强度（可选） |

---

## 🔍 错误处理

### 常见错误及解决方案

1. **图片尺寸错误**
   - 错误: `image size must be at least 3686400 pixels`
   - 解决: 代码已自动处理，确保至少 1920x1920

2. **Prompt 过长**
   - 错误: `String should have at most 10240 characters`
   - 解决: 代码限制在 10000 字符，自动截断

3. **Base64 图片**
   - 提示: Base64 图片无法直接传递到 API
   - 解决: 代码会在 prompt 中描述，但不附加到 URL 引用

---

## 🚀 测试建议

1. **单图测试**: 只上传用户照片，不选择衣物
2. **多图测试**: 上传用户照片 + 选择 1-3 件衣物
3. **尺寸测试**: 尝试不同的 width/height 组合，验证自动调整
4. **错误测试**: 测试超长 prompt、无效尺寸等情况

---

## 📊 技术细节

### 尺寸计算逻辑

```typescript
const MIN_PIXELS = 3686400  // API 要求的最小像素数
const currentPixels = width * height

if (currentPixels < MIN_PIXELS) {
  const scale = Math.sqrt(MIN_PIXELS / currentPixels)
  width = Math.ceil((width * scale) / 8) * 8
  height = Math.ceil((height * scale) / 8) * 8
}
```

### 多图处理逻辑

1. 分离 base64 和 URL 图片
2. Base64 图片：在 prompt 中描述
3. URL 图片：附加为 `--reference_image` 参数
4. 限制最多 3 个 URL 引用（避免 prompt 过长）

---

**修复完成时间**: 2025-12-11  
**版本**: v2.2

