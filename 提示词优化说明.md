# 🎨 提示词优化说明

## 📋 优化概述

作为技术主管，对 AI 图片生成的提示词系统进行了全面优化，显著提升生成质量和用户体验。

---

## ✅ 核心优化

### 1. 专业提示词构建器 (`src/lib/promptBuilder.ts`)

创建了专门的提示词构建模块，包含：

#### 质量增强标签
```typescript
"masterpiece, best quality, ultra detailed, 8k uhd, high resolution, 
photorealistic, professional photography, studio lighting, sharp focus, 
perfect composition"
```

#### 负面提示词（避免不良效果）
包含 40+ 个负面关键词，避免：
- 低质量：lowres, worst quality, low quality
- 解剖错误：bad anatomy, bad hands, extra fingers
- 变形：deformed, disfigured, mutated
- 艺术风格：cartoon, 3d render, illustration, painting
- 技术问题：blurry, grainy, noisy, jpeg artifacts

### 2. 智能场景识别

根据用户输入的 prompt 自动识别：

**场景类型**:
- 工作室 → "专业摄影工作室，纯色背景"
- 街头 → "城市街头，现代建筑背景"
- 室内 → "室内空间，简约背景"
- 户外 → "自然户外环境"

**灯光类型**:
- 柔光 → "柔和的漫射光，无强烈阴影"
- 硬光 → "戏剧性的硬光，清晰阴影"
- 自然光 → "自然日光，温暖色调"
- 工作室灯光 → "专业工作室灯光，三点布光"

**风格类型**:
- 高级 → "高端时尚大片风格"
- 日常 → "日常穿搭风格"
- 街拍 → "街头时尚风格"

### 3. 衣物描述优化

根据衣物类型和风格自动生成专业描述：

```typescript
// 示例
"白色基础 T 恤（上装，休闲风格），搭配黑色休闲裤（下装，休闲风格）"
```

### 4. 姿态和构图优化

根据用户输入自动选择：
- **正面**: "正面全身照，自然站立姿态，双手自然下垂"
- **侧面**: "侧面全身照，展现身材轮廓"
- **默认**: "全身照，自然姿态，展现完整穿搭效果"

### 5. 技术参数优化

**生成参数调整**:
- `num_inference_steps`: 28 → **30** (增加步数提升质量)
- `guidance_scale`: 3.5 → **7.5** (提高引导强度，确保更好的提示词遵循)

---

## 🎯 提示词结构

### 优化前（简单拼接）
```
"时尚写真，工作室灯光，高级质感，人物正面，穿着：白色基础 T 恤、黑色休闲裤"
```

### 优化后（专业结构）
```
"masterpiece, best quality, ultra detailed, 8k uhd, high resolution, 
photorealistic, professional photography, studio lighting, sharp focus, 
perfect composition，真实人物，保持原有人物特征和面部细节，自然表情，
正面全身照，自然站立姿态，双手自然下垂，穿着：白色基础 T 恤（上装，休闲风格），
搭配黑色休闲裤（下装，休闲风格），场景：专业摄影工作室，纯色背景，
灯光：专业工作室灯光，三点布光，风格：高端时尚大片风格，全身构图，人物居中，
背景虚化，服装细节清晰，纹理真实，色彩准确，饱和度适中，专业时尚摄影"
```

---

## 📊 优化效果

### 质量提升

1. **细节更清晰**: 添加了 "ultra detailed", "sharp focus" 等关键词
2. **真实感更强**: "photorealistic", "professional photography"
3. **构图更专业**: "perfect composition", "全身构图，人物居中"
4. **避免不良效果**: 负面提示词过滤低质量、变形等问题

### 场景适配

- 自动识别用户意图（工作室/街头/室内/户外）
- 智能匹配灯光和风格
- 根据衣物类型优化描述

### 参数优化

- 更高的推理步数 → 更精细的生成
- 更高的引导强度 → 更好的提示词遵循

---

## 🔧 技术实现

### 文件结构

```
src/lib/
├── promptBuilder.ts    # 新增：专业提示词构建器
├── ai.ts               # 更新：支持 negative_prompt
└── prompt.ts           # 原有：基础 prompt 构建（保留兼容）

src/app/
├── virtual-tryon/
│   └── page.tsx        # 更新：使用优化后的提示词构建器
└── api/
    └── ai/
        └── generate-image/
            └── route.ts # 更新：传递 negative_prompt
```

### 核心函数

#### `buildOptimizedPrompt()`
```typescript
buildOptimizedPrompt(
  userPrompt: string,        // 用户输入的 prompt
  clothingItems: ClothingItem[], // 选择的衣物
  userPhoto?: string         // 用户照片（可选）
): {
  positive: string,  // 正面提示词
  negative: string  // 负面提示词
}
```

#### `buildSimplePrompt()` (兼容函数)
```typescript
buildSimplePrompt(
  userPrompt: string,
  clothingItems: ClothingItem[]
): string
```

---

## 📝 使用示例

### 前端调用

```typescript
import { buildOptimizedPrompt } from "@/lib/promptBuilder"

const { positive, negative } = buildOptimizedPrompt(
  "时尚写真，工作室灯光，高级质感，人物正面",
  selectedItems,
  userPhoto
)

await fetch("/api/ai/generate-image", {
  method: "POST",
  body: JSON.stringify({
    prompt: positive,
    negative_prompt: negative,
    // ... 其他参数
  })
})
```

---

## 🎨 提示词模板

### 标准模板结构

```
[质量标签] + [主体描述] + [姿态描述] + [衣物描述] + 
[场景描述] + [灯光描述] + [风格描述] + [技术参数]
```

### 示例输出

**输入**:
- Prompt: "时尚写真，工作室灯光，高级质感，人物正面"
- 衣物: ["白色基础 T 恤", "黑色休闲裤"]

**输出**:
```
正面提示词:
"masterpiece, best quality, ultra detailed, 8k uhd, high resolution, 
photorealistic, professional photography, studio lighting, sharp focus, 
perfect composition，真实人物，保持原有人物特征和面部细节，自然表情，
正面全身照，自然站立姿态，双手自然下垂，穿着：白色基础 T 恤（上装，休闲风格），
搭配黑色休闲裤（下装，休闲风格），场景：专业摄影工作室，纯色背景，
灯光：专业工作室灯光，三点布光，风格：高端时尚大片风格，全身构图，人物居中，
背景虚化，服装细节清晰，纹理真实，色彩准确，饱和度适中，专业时尚摄影"

负面提示词:
"lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, 
fewer digits, cropped, worst quality, low quality, normal quality, 
jpeg artifacts, signature, watermark, username, blurry, bad feet, 
bad proportions, deformed, disfigured, mutated, ugly, duplicate, 
morbid, mutilated, extra limbs, extra arms, extra legs, malformed limbs, 
fused fingers, too many fingers, long neck, cross-eyed, bad eyes, 
out of frame, cartoon, 3d render, illustration, painting, drawing, 
sketch, anime, manga, unrealistic, distorted, grainy, noisy"
```

---

## 🚀 性能优化

### 参数调整

| 参数 | 优化前 | 优化后 | 说明 |
|------|--------|--------|------|
| `num_inference_steps` | 28 | 30 | 增加步数，提升细节质量 |
| `guidance_scale` | 3.5 | 7.5 | 提高引导强度，更好遵循提示词 |

### 提示词长度

- **优化前**: 简单拼接，约 50-100 字符
- **优化后**: 专业结构，约 200-400 字符
- **限制**: 自动截断，确保不超过 10000 字符

---

## 📈 预期效果

### 质量提升

1. ✅ **更真实的细节**: 服装纹理、面料质感更清晰
2. ✅ **更专业的构图**: 人物居中，背景虚化，专业摄影风格
3. ✅ **更准确的颜色**: 色彩准确，饱和度适中
4. ✅ **更少的错误**: 负面提示词过滤变形、低质量等问题

### 用户体验

1. ✅ **更智能**: 自动识别场景和风格
2. ✅ **更专业**: 使用专业术语和描述
3. ✅ **更灵活**: 支持自定义 prompt，自动增强

---

## 🔍 调试建议

### 查看生成的提示词

在浏览器控制台查看：
```javascript
// 查看最终发送的 prompt
console.log("Final prompt:", payload.prompt)
console.log("Negative prompt:", payload.negative_prompt)
```

### 调整参数

如果生成效果不理想，可以调整：

1. **增加推理步数**: `num_inference_steps: 35-40`
2. **调整引导强度**: `guidance_scale: 5-10`
3. **修改质量标签**: 在 `promptBuilder.ts` 中调整 `QUALITY_TAGS`
4. **优化负面提示词**: 在 `promptBuilder.ts` 中调整 `NEGATIVE_PROMPT`

---

## 📚 参考资源

- [Stable Diffusion Prompt Guide](https://stable-diffusion-art.com/prompt-guide/)
- [Negative Prompt Best Practices](https://stable-diffusion-art.com/negative-prompt/)
- [Image Generation API Documentation](https://platform.openai.com/docs/api-reference/images)

---

**优化完成时间**: 2025-12-11  
**版本**: v2.3  
**负责人**: AI Technical Lead

